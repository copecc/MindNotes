---
title: 可持久化字典树
tags:
  - Persistent Trie
---

# 可持久化字典树

可持久化字典树（$\text{Persistent Trie}$）是一种支持版本控制的字典树数据结构。它允许在插入或删除字符串时，保留之前版本的状态，从而可以访问历史版本的数据。

## 可持久化字典树的实现

类似可持久化线段树，每次插入或删除字符串时，只需克隆受影响的节点，从而实现版本的持久化。未被修改的节点可以共享。

???+ note "[字符串树](https://www.luogu.com.cn/problem/P6088){target=_blank}"

    给定一棵有 $N$ 个节点的树，每条边上都有一个字符串作为标签。现在有 $Q$ 个查询，每个查询给出两个节点 $u$ 和 $v$ 以及一个字符串 $s$，要求计算从节点 $u$ 到节点 $v$ 的路径上，标签中以字符串 $s$ 作为前缀的边的数量。

    ??? hint

        查询从根节点到节点 $u$ 和节点 $v$ 的路径上满足条件的边的数量，然后减去从根节点到它们的最近公共祖先节点 $lca(u, v)$ 的路径上满足条件的边的数量的两倍。

    ```cpp
    --8<--  "code/PDS/Trie/P6088.cpp"
    ```

## 可持久化0-1字典树

可持久化 $\text{0-1}$ 字典树是一种特殊的字典树，主要用于存储二进制字符串（由 $0$ 和 $1$ 组成的字符串）。它支持插入、删除和查询操作，同时保留历史版本的信息。

???+ note "[最大异或和](https://www.luogu.com.cn/problem/P4735){target=_blank}"

    给定一个非负数组 $a$，初始长度为 $N$。有 $M$ 个操作，有以下两种操作类型：

    1. 添加操作：表示在序列末尾添加一个数 $x$，序列的长度 $N$ 加 $1$。
    2. 询问操作：找到一个位置 $p$，满足 $l \leq p \leq r$，使得：$a[p] \oplus a[p+1] \oplus \dots \oplus a[N] \oplus x$ 最大，输出最大值。
  
    ??? hint

        定义前缀异或数组 $eor[i] = a[1] \oplus a[2] \oplus ... \oplus a[i]$，那么
        
        $$
        a[p] \oplus a[p+1] \oplus ... \oplus a[N] = eor[p-1] \oplus eor[N]
        $$

        因此，问题转化为在区间 $[l-1, r-1]$ 内寻找一个 $eor[i]$，使得 $eor[i] \oplus eor[N] \oplus x$ 最大。

        使用可持久化 $\text{0-1}$ 字典树存储前缀异或数组 $eor$ 的各个版本。在查询时，利用版本号来限定查询的范围。区间 $[l-1, r-1]$ 对应的版本号为 $roots[l-2]$ 和 $roots[r-1]$。

    !!! tip
    
        注意区分空版本和 $0$ 版本的区别，空版本表示没有任何数插入，而 $0$ 版本表示插入了数 $0$。

    ```cpp
    --8<--  "code/PDS/Trie/P4735.cpp"
    ```