---
title: 可持久化并查集
tags:
  - Persistent Disjoint Set Union
---

# 可持久化并查集

可持久化并查集（$\text{Persistent Disjoint Set Union}$）是一种支持版本控制的并查集数据结构。它允许在合并集合时，保留之前版本的状态，从而可以访问历史版本的数据。

在普通并查集中，常常使用路径压缩和按秩合并来优化查询和合并操作。而在可持久化并查集中，为了实现版本控制，需要在每次合并操作时，克隆受影响的节点，未被修改的节点可以共享。因此常常只使用按秩合并来简化实现。

???+ note "[【模板】可持久化并查集](https://www.luogu.com.cn/problem/P3402){target=_blank}"

    给定 $N$ 个元素，初始时每个元素各自为一个集合。现在有 $M$ 个操作，有以下三种操作类型：

    1. 合并操作：将两个元素所在的集合合并为一个集合。
    2. 回滚操作：将当前版本回滚到某个历史版本。
    3. 查询操作：查询某个版本中两个元素是否在同一个集合中。

    每次操作都会生成一个新的版本，版本号从 $1$ 开始递增。

    ```cpp
    --8<--  "code/PDS/DSU/P3402.cpp"
    ```
    {.annotate}

    1. 每次合并时，如果将$u$和$v$所在的集合合并，则需要更新 $v$ 的父节点为 $u$，并且更新 $u$ 的秩，总共两次更新操作，因此需要克隆两次节点。将两次操作结束后的根节点作为新版本的根节点返回。