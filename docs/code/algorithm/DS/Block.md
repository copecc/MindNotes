---
title: 分块
tags:
  - Block
---

# 分块

分块的基本思想是将数据划分为若干个大小相等的块，从而在块内进行操作以提高效率。分块技术常用于处理大规模数据集，尤其是在需要频繁查询和更新的场景中。

一般情况下，分块的大小选择为 $\sqrt{n}$，这样可以在 $O(\sqrt{n})$ 的时间复杂度内完成查询和更新操作。总体时间复杂度通常为 $O((n + q) \sqrt{n})$，其中 $n$ 是数据规模，$q$ 是操作次数。

## 区间查询

分块可以有效地处理区间查询问题。通过将数据划分为若干个块，可以在块内进行快速查询，同时在块之间进行合并操作。查询时对于完全包含的块可以直接使用预处理的信息，而对于部分包含的块则需要逐个处理。

???+ note "[Give Away](https://www.spoj.com/problems/GIVEAWAY/){target=_blank}"

    给定一个长度为 $n$ 的数组，支持两种操作：

    1. 查询区间 $[l, r]$ 中大于等于 $x$ 的元素个数。
    2. 修改数组中某个位置的元素值。

    ```cpp
    --8<-- "code/DS/Block/SP18185.cpp"
    ```

## 带修改的区间查询

对于需要支持区间修改的查询问题，分块技术同样适用。通过在每个块中维护一个延迟标记，可以在查询时考虑这些修改，从而提高效率。如果修改操作覆盖整个块，可以直接更新块的标记，而无需逐个更新块内的元素。对于部分覆盖的块，则需要逐个更新块内的元素。

???+ note "[教主的魔法](https://www.luogu.com.cn/problem/P2801){target=_blank}"

    给定一个长度为 $n$ 的数组，支持两种操作：

    1. 查询区间 $[l, r]$ 中大于等于 $x$ 的元素个数。
    2. 将区间 $[l, r]$ 内的所有元素增加一个值 $v$。

    ```cpp
    --8<-- "code/DS/Block/P2801.cpp"
    ```

## 块间信息合并

在处理区间查询时，可能会遇到需要根据块间信息进行合并的情况，常常需要讨论散块对散块、散块对整块、整块对整块等多种情况。

??? note "[Yuno loves sqrt technology I](https://www.luogu.com.cn/problem/P5046){target=_blank}"

    给定一个长度为 $n$ 的数组，支持查询区间 $[l, r]$ 中的逆序对数量。

    ??? hint

        1. 将数组分块，预处理每个块内的逆序对数量，并计算前缀和和后缀和。
        2. 对于查询区间 $[l, r]$，根据 $l$ 和 $r$ 所在的块进行分类讨论：
            - 如果 $l$ 和 $r$ 在同一块内，直接使用前缀和计算，并减去不合法的逆序对数量。
            - 如果 $l$ 和 $r$ 跨越多个块：包括（1）左边散块和右边散块各自的逆序对数量（2）左边散块与右边散块的逆序对数量（3）左边散块与中间整块的逆序对数量（4）右边散块与中间整块的逆序对数量（5）中间整块之间的逆序对数量。

    ```cpp
    --8<-- "code/DS/Block/P5046.cpp"
    ```

    ??? warning "RE与TLE"
  
        使用`std::cin`和`std::cout`会`RE`？尚不清楚原因，改用`scanf`和`printf`后通过。

        时限为`750ms`，前三个测评点卡上限通过，大约`700ms`。