---
title: 树上启发式合并
tags:
  - DSU on Tree
---

# 树上启发式合并

树上启发式合并（$\text{DSU on Tree}$）是一种用于处理树形数据结构上的查询和更新操作的技术。它结合了并查集（$\text{Disjoint Set Union, DSU}$）和树的深度优先搜索（$\text{DFS}$）方法，能够高效地解决一些复杂的问题，如子树查询、路径查询等。

在并查集中常见的启发式合并策略包括按秩合并和按大小合并。树上启发式合并则利用了树的结构特点，通过区分不同子树的大小，优先合并较小的子树，从而减少不必要的计算和内存开销。

树上启发式合并的特征：

1. 没有修改操作
2. 可以通过遍历子树建立信息统计，得到所有查询的答案

树上启发式合并使用深度优先搜索（$\text{DFS}$）遍历树的节点，附加一个 $keep$ 标记表示是否保留子树对信息的贡献，并在遍历过程中维护一个数据结构来存储当前子树的信息。具体步骤如下：

1. 先遍历所有轻儿子的子树，遍历结束时，消除对信息的贡献。即：$dfs(轻儿子, false)$
2. 再遍历唯一重儿子的子树，遍历结束时，保留对信息的贡献。即：$dfs(重儿子, true)$
3. 考察单个节点 $u$，对信息进行贡献
4. 再遍历所有轻儿子的子树上面的每个节点，都重新对信息进行贡献
5. 得到子树 $u$ 的答案
6. 如果 $keep == false$，消除子树 $u$ 的贡献；如果 $keep == true$，保留子树 $u$ 的贡献

时间复杂度：$O(N \log N)$

???+ note "[树上数颜色](https://www.luogu.com.cn/problem/U41492){target=_blank}"

    给定一棵有 $N$ 个节点的树，每个节点有一个颜色。对于每个查询，求以节点 $u$ 为根的子树中有多少种不同的颜色。

    ```cpp
    --8<-- "code/Tree/DSU/U41492.cpp"
    ```