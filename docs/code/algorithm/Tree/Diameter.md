---
title: 树的直径
tags:
  - 直径
  - Diameter
---

# 树的直径

树的直径是指树中任意两个节点之间路径长度的最大值。

树的直径有如下性质：

1. 如果有多条直径，那么这些直径一定拥有共同的中间部分，可能是一个公共点或一段公共路径
2. 树上任意一点，相隔最远的点的集合，直径的两端点至少有一个在其中


???+ "[【模板】树的直径](https://www.luogu.com.cn/problem/U81904){target=_blank}"
    
    === "两次 $\text{DFS}$"

        适用于边权非负的树，不仅能得到直径的长度，还能得到直径沿途所有点

        !!! warning "要求边权非负"
            
            本题中边权可能为负数，不能通过全部测试

        ```cpp
        --8<-- "code/Tree/Diameter/U81904_1.cpp"
        ```

    === "树形 $\text{DP}$"

        适用于边权可以为负的树，只能得到直径的长度

        ```cpp
        --8<-- "code/Tree/Diameter/U81904_2.cpp"
        ```

    === "树形 $\text{DP}$（简化）"

        省略了 `answer` 数组，直接在 `dfs` 中更新直径

        === "实现一"

            ```cpp
            --8<-- "code/Tree/Diameter/U81904_3.cpp"
            ```
            {.annotate}

            1. `first_max` 和 `second_max` 分别记录子节点中最大的和第二大的 `max_dist`，这样可以避免在更新 `diameter` 时重复计算。
            
        === "实现二"

            ```cpp
            --8<-- "code/Tree/Diameter/U81904_4.cpp"
            ```
            {.annotate}

            2. 更新经过`x`的最长路径，必须在更新`max_dist[x]`之前，因为`max_dist[x]`此时记录的是已经遍历过的子节点中最大的`max_dist`。否则`y`节点的贡献会被错误计算。

## 直径的公共部分

由于树的直径可能不唯一，但它们一定拥有共同的中间部分，可能是一个公共点或一段公共路径。

如果树的边权都为正数，可以通过两次 $\text{DFS}$ 找到一条直径，然后从直径的两个端点同时向中间移动，直到相遇，所经过的路径即为所有直径的公共部分。

???+ "[直径](https://www.luogu.com.cn/problem/P3304){target=_blank}"

    对于给定的一棵树，边权为正整数，其直径的长度是多少，以及有多少条边满足所有的直径都经过该边。

    ```cpp
    --8<-- "code/Tree/Diameter/P3304.cpp"
    ```
    {.annotate}

    1. 公共边即为从 `right` 到 `left` 的路径上的边，每条边可以表示为`(last[i], i)`