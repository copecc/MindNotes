---
title: 线段树分治
tag:
  - Segment Tree
  - DC
---

# 线段树分治

线段树分治是一种结合了线段树和分治思想的数据结构与算法设计方法。

对于一些动态修改和查询的问题，传统的数据结构可能无法高效处理频繁的修改操作。而线段树分治通过将时间维度引入线段树结构中，实现对动态操作的高效管理。

解决问题时，可以把每条操作分配一个时间点，建立时间轴线段树。每种修改操作，拥有若干个有效时间段，对应着线段树上的若干区间。每条查询操作对应在某个时间点上相关的状态信息。

线段树分治的过程：

1. 先把所有操作记录分类，每种修改操作整理出若干个有效时间段
2. 根据每个有效时间段，把任务分配到线段树的区间上
3. 遍历整棵线段树，来到某个线段树的区间时执行相应的任务，离开区间时撤销相应的任务
4. 线段树的叶节点对应着单个时间点，如果有查询操作需要记录查询的答案

使用场景：

1. 在线算法实现困难较大，可能需要更高级的数据结构，或者时间复杂度无法达到预期
2. 没有强制在线的要求，并且操作的次序可以转化成离线的时序

线段树分治的时间复杂度：

1. 操作的数量为 $m$，每个有效时间段会分解成 $\log m$ 个线段树的区间
2. 每个线段树区间都留有这个操作的任务，那么任务总数为 $m * \log m$
3. 执行任务和撤销任务，使用到可撤销并查集，并查集上点的个数为 $n$，单次操作的代价为 $\log n$

时间复杂度一般为，$O(m * \log m * \log n)$

???+ note "[动态图连通性](https://loj.ac/p/121){target=_blank}"

    维护一张无向简单图。你被要求加入删除一条边及查询两个点是否连通。

    0：加入一条边。保证它不存在。
    1：删除一条边。保证它存在。
    2：查询两个点是否连通。

    ??? hint

        建立时间轴线段树，使用可撤销并查集维护连通性。建立线段树时按边和时间排序，方便统计每条边的有效时间段。

    ```cpp
    --8<-- "code/DC/SegmentTree/LOJ121.cpp"
    ```

???+ note "[最小mex生成树](https://www.luogu.com.cn/problem/P5631){target=_blank}"

    给定一个带权无向图，边的权值为非负整数。定义一棵生成树的 $\text{MEX}$ 为不在生成树边权值中的最小非负整数。求所有生成树中 $\text{MEX}$ 最小的生成树对应的 $\text{MEX}$ 值。

    ??? hint

        在 $\text{MEX}$ 为 $w$ 的生成树中，边的权值不能为 $w$。 因此可以将权值为 $w$ 的边，添加到权值轴线段树上，区间为 $[0, w-1]$ 和 $[w+1, \text{max\_w} + 1]$。使用可撤销并查集维护连通性，查询时判断是否连通。

    ```cpp
    --8<-- "code/DC/SegmentTree/P5631.cpp"
    ```